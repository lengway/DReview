<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Review ‚Äî Loading...</title>
    <script src="/scripts/styleLoader.js" defer></script>
</head>

<body id="game-page">
    <div id="scroll-progress"></div>
    <div id="overlay" class="overlay"></div>
    <div class="layout" id="layout">
        <header class="header" id="header">
        </header>

        <aside class="sidebar" id="sidebar">
        </aside>

        <main class="main" id="main">
            <section class="hero">
                <div class="container">
                    <h1 class="hero-title" id="hero-title"><!--js--></h1>
                </div>
            </section>


            <section class="section panel">
                <div class="container">
                    <div class="review-row">
                        <div class="cover">
                            <img src="" alt="" id="cover">
                        </div>

                        <div class="review-title">
                            <h2 id="summary-heading"></h2>

                            <p class="description" id="description">
                            </p>
                            
                            <div class="add-review-wrapper">
                                <button id="addReviewBtn" class="btn btn-add-review">
                                    <span>‚úé</span>
                                    <span>Add Review</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div id="reviews" class="reviews"></div>
        </main>

        <footer class="footer" id="footer">
        </footer>
    </div>

    <!-- Add Review Popup -->
    <div class="popup-overlay" id="addReviewPopup" hidden>
        <div class="popup">
            <button class="popup-close" id="closeReviewPopupBtn">&times;</button>
            <div class="popup-header">
                <h3>Add Review</h3>
            </div>
            <form id="addReviewForm" class="popup-content">
                <div class="form-group">
                    <label for="reviewTitle">Title</label>
                    <input type="text" id="reviewTitle" placeholder="Enter review title" required>
                </div>
                <div class="form-group">
                    <label for="reviewRating">Rating</label>
                    <div class="rating-input" id="ratingInput">
                        <span class="star" data-rating="1">‚≠ê</span>
                        <span class="star" data-rating="2">‚≠ê</span>
                        <span class="star" data-rating="3">‚≠ê</span>
                        <span class="star" data-rating="4">‚≠ê</span>
                        <span class="star" data-rating="5">‚≠ê</span>
                    </div>
                    <input type="hidden" id="reviewRatingValue" value="0" required>
                </div>
                <div class="form-group">
                    <label for="reviewBody">Review</label>
                    <textarea id="reviewBody" rows="6" placeholder="Write your review..." required></textarea>
                </div>
                <div class="popup-actions">
                    <button type="button" class="btn btn-ghost" id="cancelReviewBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/env.js"></script>
    <script src="/scripts/main.js" defer></script>
    <script src="/scripts/sidebarToggle.js" defer></script>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js'
        import { showLocalToast } from '/scripts/popup.js'

        // const SUPABASE_URL = 'http://127.0.0.1:54321'
        // const SUPABASE_ANON_KEY = 'sb_publishable_ACJWlzQHlZjBrEguHvfOxg_3BJgxAaH'

        const SUPABASE_URL = "https://zqdqbvcppkwurakulier.supabase.co"
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxZHFidmNwcGt3dXJha3VsaWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MDc3NTAsImV4cCI6MjA3NTI4Mzc1MH0.jp0RmoPLurjNVdQNxsLdVtwrm0yWnMW3_dRi3slSd7I" // —Ç–≤–æ–π anon key


        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            console.error('Missing Supabase config. Make sure env.js is loaded and contains SUPABASE_URL and SUPABASE_ANON_KEY.')
        }

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // const defaultAvatar = '/images/default-avatar.png'

        // helper: get ?slug=... from URL 
        function getSlug() {
            const params = new URLSearchParams(location.search)
            return params.get('slug') || null
        }

        function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]) }

        (async function main() {
            const slug = getSlug()
            if (!slug) {
                document.getElementById('title').textContent = '–ù–µ —É–∫–∞–∑–∞–Ω slug'
                return
            }

            // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, movie –∏–ª–∏ game –ø–æ –ø—É—Ç–∏: –µ—Å–ª–∏ –≤ —É—Ä–ª–µ –µ—Å—Ç—å /games/ –∏–ª–∏ /games.html
            const path = location.pathname.toLowerCase()
            const productType = path.includes('/games') || path.includes('game') ? 'game' : 'movie'
            const tableName = productType === 'game' ? 'games' : 'movies'

            try {
                // —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ slug, –∑–∞—Ç–µ–º ‚Äî –ø–æ id
                let { data: product, error } = await supabase
                    .from(tableName)
                    .select('id, title, description, img_url, created_at, slug')
                    .eq('slug', slug)
                    .maybeSingle()

                if (!product) {
                    // –ø–æ–ø—Ä–æ–±—É–µ–º –∫–∞–∫ id
                    const { data: byId } = await supabase
                        .from(tableName)
                        .select('id, title, description, img_url, created_at, slug')
                        .eq('id', slug)
                        .maybeSingle()
                    product = byId
                }

                if (!product) {
                    document.getElementById('not-found').style.display = 'block'
                    document.getElementById('title').textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ'
                    return
                }

                // –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–ª–æ–∫–∞
                document.getElementById('hero-title').textContent = product.title + ' Review'
                document.getElementById('summary-heading').textContent = product.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'
                document.getElementById('description').textContent = product.description || ''
                document.getElementById('cover').src = product.img_url || '/images/placeholder.png'
                document.title = 'DReview  ‚Äî ' + (product.title)
                //–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä—ã —á–µ—Ä–µ–∑ RAWG API
const RAWG_API_KEY = '13c6f521633d44d5b52b4cd25b2fd2dc' 

async function fetchRawgRating(title) {
    try {
        const url = `https://api.rawg.io/api/games?key=${RAWG_API_KEY}&search=${encodeURIComponent(title)}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.results && data.results.length > 0) {
            const game = data.results[0];
            return game.rating; 
        }
        return null;
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ RAWG API:', err);
        return null;
    }
}

const rawgRating = await fetchRawgRating(product.title);
if (rawgRating) {
    const ratingEl = document.createElement('div');
    ratingEl.className = 'rawg-rating';
    ratingEl.style.marginTop = '8px';
    ratingEl.style.fontSize = '18px';
    ratingEl.textContent = `‚≠ê RAWG Rating: ${2*rawgRating.toFixed(1)}`;
    document.querySelector('#summary-heading').append(ratingEl);
}


                // –∑–∞–≥—Ä—É–∑–∏–º —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ —á–µ—Ä–µ–∑ RPC (–µ—Å–ª–∏ –µ—Å—Ç—å)
                try {
                    const { data: stats, error: statsErr } = await supabase.rpc('get_product_review_stats', { p_type: productType, p_id: product.id })
                    if (statsErr) {
                        // –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
                        console.warn('RPC get_product_review_stats error:', statsErr)
                    } else if (stats && stats.length) {
                        const avg = stats[0].avg_rating ? Number(stats[0].avg_rating).toFixed(2) : '‚Äî'
                        document.getElementById('meta').textContent = `–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ‚≠ê ${avg}`
                    }
                } catch (e) {
                    // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ RPC –Ω–µ—Ç –∏–ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
                    console.warn('RPC call failed (ignored):', e)
                }

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤
                async function loadReviews() {
                    const { data: reviews, error: revErr } = await supabase
                        .from('reviews')
                        .select('id, rating, body, user_id, created_at, title')
                        .eq('product_type', productType)
                        .eq('product_id', product.id)
                        .eq('is_published', true)
                        .order('created_at', { ascending: false })

                    if (revErr) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤:', revErr)
                        document.getElementById('reviews').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç–∑—ã–≤–æ–≤'
                        return
                    }

                    const reviewsEl = document.getElementById('reviews')
                    reviewsEl.innerHTML = ''

                    if (!reviews || reviews.length === 0) {
                        reviewsEl.textContent = 'No reviews yet ‚Äî be the first. üëä'
                        return
                    }

                    // —Å–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ user_id —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å full_name –∏–∑ profiles
                    const userIds = Array.from(new Set(reviews.map(r => r.user_id).filter(Boolean)))
                    let profilesMap = {}
                    if (userIds.length) {
                        const { data: profiles, error: profErr } = await supabase
                            .from('profiles')
                            .select('id, full_name, avatar_url')
                            .in('id', userIds)

                        if (!profErr && profiles) {
                            profilesMap = profiles.reduce((acc, p) => {
                                acc[p.id] = { name: p.full_name || null, avatar: p.avatar_url || null }
                                return acc
                            }, {})
                        } else if (profErr) {
                            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å profiles:', profErr)
                        }
                    }

                    // —Ä–µ–Ω–¥–µ—Ä–∏–º –æ—Ç–∑—ã–≤—ã —Å –∏–º–µ–Ω–∞–º–∏ –∏ –∞–≤–∞—Ç–∞—Ä–∫–∞–º–∏ –∏–∑ profiles
                    for (const r of reviews) {
                        const div = document.createElement('div')
                        div.className = 'review'
                        const when = r.created_at ? new Date(r.created_at).toLocaleString() : ''
                        const profile = r.user_id ? profilesMap[r.user_id] : null
                        const authorName = profile?.name ? profile.name : (r.user_id ? ('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + r.user_id.slice(0, 6)) : '–ê–Ω–æ–Ω–∏–º')
                        const avatarSrc = profile?.avatar ? profile.avatar : '/images/avatar-placeholder.png'
                        const reviewTitle = r.title ? `<h4>${escapeHtml(r.title)}</h4>` : ''
                        div.innerHTML = `
                            <article class="review-item">
                                <div class="review-left">
                                    <a href="/pages/user.html?id=${encodeURIComponent(r.user_id || '')}">
                                        <img class="review-avatar" src="${escapeHtml(avatarSrc)}" alt="${escapeHtml(authorName)}" />
                                    </a>
                                    <div class="review-author">${escapeHtml(authorName)}</div>
                                    <div class="review-rating">‚≠ê ${escapeHtml(String(r.rating ?? '-'))}</div>
                                </div>

                                <div class="review-content">
                                    <div class="review-body">
                                        ${reviewTitle}
                                        <div class="review-text">
                                            ${escapeHtml(r.body || '')}
                                        </div>
                                    </div>
                                    <div class="review-footer">
                                        ${escapeHtml(when)}
                                    </div>
                                </div>
                            </article>
                            `
                        reviewsEl.appendChild(div)
                    }
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã
                await loadReviews()

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º product –∏ productType –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
                window.currentProduct = product
                window.currentProductType = productType

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ—Ç–∑—ã–≤ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const { data: { user } } = await supabase.auth.getUser()
                if (user) {
                    const { data: existingReview } = await supabase
                        .from('reviews')
                        .select('id')
                        .eq('product_type', productType)
                        .eq('product_id', product.id)
                        .eq('user_id', user.id)
                        .maybeSingle()

                    if (existingReview) {
                        const addReviewBtn = document.getElementById('addReviewBtn')
                        if (addReviewBtn) {
                            addReviewBtn.style.display = 'none'
                        }
                        window.hasExistingReview = true
                    } else {
                        window.hasExistingReview = false
                    }
                }

            } catch (err) {
                console.error(err)
                document.getElementById('title').textContent = 'Loading error.'
                document.getElementById('reviews').textContent = 'Cannot fetch data.'
            }
        })()

        // –õ–æ–≥–∏–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞
        const addReviewBtn = document.getElementById('addReviewBtn')
        const addReviewPopup = document.getElementById('addReviewPopup')
        const closeReviewPopupBtn = document.getElementById('closeReviewPopupBtn')
        const cancelReviewBtn = document.getElementById('cancelReviewBtn')
        const addReviewForm = document.getElementById('addReviewForm')
        const ratingInput = document.getElementById('ratingInput')
        const reviewRatingValue = document.getElementById('reviewRatingValue')
        const stars = ratingInput.querySelectorAll('.star')

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–π—Ç–∏–Ω–≥–∞ (–∑–≤–µ–∑–¥–æ—á–∫–∏)
        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                const rating = index + 1
                reviewRatingValue.value = rating
                stars.forEach((s, i) => {
                    if (i < rating) {
                        s.classList.add('active')
                    } else {
                        s.classList.remove('active')
                    }
                })
            })
        })

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–ø–∞–ø–∞
        addReviewBtn?.addEventListener('click', async () => {
            const { data: { user } } = await supabase.auth.getUser()
            if (!user) {
                showLocalToast('Please sign in to add a review', 'warning')
                setTimeout(() => {
                    window.location.href = '/pages/signin.html'
                }, 1500)
                return
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ—Ç–∑—ã–≤
            if (window.hasExistingReview) {
                showLocalToast('You have already submitted a review for this product', 'info')
                return
            }
            
            addReviewPopup.hidden = false
            document.body.style.overflow = 'hidden'
        })

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–ø–∞–ø–∞
        function closeReviewPopup() {
            addReviewPopup.hidden = true
            document.body.style.overflow = ''
            addReviewForm.reset()
            reviewRatingValue.value = '0'
            stars.forEach(s => s.classList.remove('active'))
        }

        closeReviewPopupBtn?.addEventListener('click', closeReviewPopup)
        cancelReviewBtn?.addEventListener('click', closeReviewPopup)
        addReviewPopup?.addEventListener('click', (e) => {
            if (e.target === addReviewPopup) {
                closeReviewPopup()
            }
        })

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        addReviewForm?.addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const { data: { user } } = await supabase.auth.getUser()
            if (!user) {
                showLocalToast('Please sign in to add a review', 'warning')
                return
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ—Ç–∑—ã–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            if (window.hasExistingReview) {
                showLocalToast('You have already submitted a review for this product', 'info')
                closeReviewPopup()
                return
            }

            const title = document.getElementById('reviewTitle').value.trim()
            const rating = parseInt(reviewRatingValue.value)
            const body = document.getElementById('reviewBody').value.trim()

            if (!rating || rating < 1 || rating > 5) {
                showLocalToast('Please select a rating', 'warning')
                return
            }

            if (!window.currentProduct || !window.currentProductType) {
                showLocalToast('Error: Product information not found', 'error')
                return
            }

            const submitBtn = addReviewForm.querySelector('button[type="submit"]')
            const originalText = submitBtn.textContent
            submitBtn.disabled = true
            submitBtn.textContent = 'Submitting...'

            try {
                const { error } = await supabase
                    .from('reviews')
                    .insert({
                        product_type: window.currentProductType,
                        product_id: window.currentProduct.id,
                        user_id: user.id,
                        title: title,
                        rating: rating,
                        body: body,
                        is_published: true
                    })

                if (error) {
                    throw error
                }

                // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –æ—Ç–∑—ã–≤ —É–∂–µ –µ—Å—Ç—å
                window.hasExistingReview = true
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                const addReviewBtn = document.getElementById('addReviewBtn')
                if (addReviewBtn) {
                    addReviewBtn.style.display = 'none'
                }

                closeReviewPopup()
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã
                if (window.loadReviews) {
                    await window.loadReviews()
                } else {
                    location.reload()
                }

                showLocalToast('Review added successfully!', 'success')
            } catch (error) {
                console.error('Error adding review:', error)
                showLocalToast('Failed to add review. Please try again.', 'error')
            } finally {
                submitBtn.disabled = false
                submitBtn.textContent = originalText
            }
        })

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é loadReviews –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.loadReviews = async function() {
            if (!window.currentProduct || !window.currentProductType) return
            
            const productType = window.currentProductType
            const product = window.currentProduct
            
            const { data: reviews, error: revErr } = await supabase
                .from('reviews')
                .select('id, rating, body, user_id, created_at, title')
                .eq('product_type', productType)
                .eq('product_id', product.id)
                .eq('is_published', true)
                .order('created_at', { ascending: false })

            if (revErr) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤:', revErr)
                document.getElementById('reviews').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç–∑—ã–≤–æ–≤'
                return
            }

            const reviewsEl = document.getElementById('reviews')
            reviewsEl.innerHTML = ''

            if (!reviews || reviews.length === 0) {
                reviewsEl.textContent = 'No reviews yet ‚Äî be the first. üëä'
                return
            }

            const userIds = Array.from(new Set(reviews.map(r => r.user_id).filter(Boolean)))
            let profilesMap = {}
            if (userIds.length) {
                const { data: profiles, error: profErr } = await supabase
                    .from('profiles')
                    .select('id, full_name, avatar_url')
                    .in('id', userIds)

                if (!profErr && profiles) {
                    profilesMap = profiles.reduce((acc, p) => {
                        acc[p.id] = { name: p.full_name || null, avatar: p.avatar_url || null }
                        return acc
                    }, {})
                }
            }

            for (const r of reviews) {
                const div = document.createElement('div')
                div.className = 'review'
                const when = r.created_at ? new Date(r.created_at).toLocaleString() : ''
                const profile = r.user_id ? profilesMap[r.user_id] : null
                const authorName = profile?.name ? profile.name : (r.user_id ? ('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + r.user_id.slice(0, 6)) : '–ê–Ω–æ–Ω–∏–º')
                const avatarSrc = profile?.avatar ? profile.avatar : '/images/avatar-placeholder.png'
                const reviewTitle = r.title ? `<h4>${escapeHtml(r.title)}</h4>` : ''
                div.innerHTML = `
                    <article class="review-item">
                        <div class="review-left">
                            <a href="/pages/user.html?id=${encodeURIComponent(r.user_id || '')}&apikey=${encodeURIComponent(SUPABASE_ANON_KEY)}">
                                <img class="review-avatar" src="${escapeHtml(avatarSrc)}" alt="${escapeHtml(authorName)}" />
                            </a>
                            <div class="review-author">${escapeHtml(authorName)}</div>
                            <div class="review-rating">‚≠ê ${escapeHtml(String(r.rating ?? '-'))}</div>
                        </div>

                        <div class="review-content">
                            <div class="review-body">
                                ${reviewTitle}
                                <div class="review-text">
                                    ${escapeHtml(r.body || '')}
                                </div>
                            </div>
                            <div class="review-footer">
                                ${escapeHtml(when)}
                            </div>
                        </div>
                    </article>
                    `
                reviewsEl.appendChild(div)
            }
        }
    </script>
</body>

</html>