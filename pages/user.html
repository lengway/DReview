<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DReview — </title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/fragments.css" />
    <link rel="icon" href="/images/logo.png" type="image/png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>

<body id="user-page">
    <div id="scroll-progress"></div>
    <div id="overlay" class="overlay"></div>
    <div class="layout" id="layout">
        <div class="header"></div>
        <aside class="sidebar"></aside>

        <main id="app" class="main">
            <div class="profile">
                <div class="container">
                    <div class="profile-card">
                        <div class="profile-top">
                            <div class="profile-info">
                                <div class="avatar-container">
                                    <img class="avatar" id="avatar" src="" alt="avatar" />
                                    <!-- <div class="avatar-actions">
                                    <button class="avatar-btn" id="uploadAvatarBtn">
                                        <i class="fas fa-upload"></i> Upload Photo
                                    </button>
                                    <button class="avatar-btn" id="removeAvatarBtn">
                                        <i class="fas fa-trash"></i> Remove Photo
                                    </button>
                                </div> -->
                                    <!-- <input type="file" id="avatarInput" accept="image/*" style="display: none;" /> -->
                                </div>
                                <div class="profile-text">
                                    <h3 id="full_name_display"></h3>
                                    <p id="bio_display" class="hero-subtitle"></p>
                                </div>
                            </div>
                            <div class="reviews-stat">
                                <span class="stat-label">Reviews written</span>
                                <span class="stat-value" id="reviews_count">0</span>
                            </div>
                        </div>
                        <div class="profile-bottom">
                            <div class="favorite-column">
                                <span class="stat-label">Favorite Game</span>
                                <div class="favorite-item" id="favorite_game">
                                    <div class="no-favorite">No favorite game selected</div>
                                    <!-- <button class="choose-btn" data-type="game">Choose Game</button> -->
                                </div>
                            </div>
                            <div class="favorite-column">
                                <span class="stat-label">Favorite Movie</span>
                                <div class="favorite-item" id="favorite_movie">
                                    <div class="no-favorite">No favorite movie selected</div>
                                    <!-- <button class="choose-btn" data-type="movie">Choose Movie</button> -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <div class="container">
                    <form id="profile-form">
                        <label>Full name
                            <input id="full_name_input" type="text" />
                        </label>
                        <label>
                            Your email is: <span id="user-email"></span>
                        </label>
                        <label>About me
                            <textarea id="bio" rows="4"></textarea>
                        </label>
                        <button type="submit">Save</button>
                    </form>
                    <button id="logoutBtn">Quit</button>
                </div> -->

                <!-- Popup for choosing favorite game/movie -->
                <!-- <div class="popup-overlay" id="chooseFavoritePopup" hidden>
                    <div class="popup">
                        <button class="popup-close" id="closePopupBtn">&times;</button>
                        <div class="popup-header">
                            <h3 id="popupTitle">Choose Favorite</h3>
                            <div class="search-box">
                                <input type="text" id="searchInput" placeholder="Search..." />
                            </div>
                        </div>
                        <div class="popup-content">
                            <div class="items-grid" id="itemsGrid"></div>
                        </div>
                    </div>
                </div> -->
            </div>
        </main>
    </div>

    <footer class="footer"></footer>
    <script src="/env.js"></script>
    <script type="module" src="/scripts/main.js" defer></script>
    <script src="/scripts/sidebarToggle.js" defer></script>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        // Конфигурация Supabase
        // const SUPABASE_URL = 'http://127.0.0.1:54321'
        // const SUPABASE_ANON_KEY = 'sb_publishable_ACJWlzQHlZjBrEguHvfOxg_3BJgxAaH'

        const SUPABASE_URL = "https://zqdqbvcppkwurakulier.supabase.co"
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxZHFidmNwcGt3dXJha3VsaWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MDc3NTAsImV4cCI6MjA3NTI4Mzc1MH0.jp0RmoPLurjNVdQNxsLdVtwrm0yWnMW3_dRi3slSd7I" // твой anon key

        // Проверка конфигурации
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            console.error('Missing Supabase config. Make sure env.js is loaded and contains SUPABASE_URL and SUPABASE_ANON_KEY.')
        }

        // Создание клиента Supabase
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        function getId() {
            const params = new URLSearchParams(location.search)
            return params.get('id') || null
        }

        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[c])
        }

        async function getCurrentUser() {
            const { data, error } = await supabase.auth.getUser()
            if (error) {
                console.error('supabase.auth.getUser error', error)
                return { user: null, error }
            }
            return { user: data?.user ?? null, error: null }
        }

        (async function main() {
            try {
                // Получаем ID пользователя из URL
                const id = getId()
                if (!id) {
                    const heroTitle = document.querySelector('.hero-title')
                    if (heroTitle) {
                        heroTitle.textContent = 'User ID not specified'
                    }
                    console.warn('No user ID provided in URL query parameter')
                    return
                }

                console.log('Loading user data for ID:', id)

                // Получаем данные пользователя из таблицы users
                const { data: userData, error: userError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', id)
                    .single()

                // Проверяем наличие ошибок
                if (userError || !userData) {
                    console.error('Error fetching user data:', userError)
                    const heroTitle = document.querySelector('.hero-title')
                    if (heroTitle) {
                        heroTitle.textContent = 'User not found'
                    }
                    return
                }

                console.log('User data loaded successfully:', userData)

                const { count, error: countError } = await supabase
                    .from('reviews')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', userData.id)

                if (countError) {
                    console.error('Error fetching reviews count:', countError)
                }

                console.log('Reviews count:', count)

                // Обновляем заголовок страницы
                /// const heroTitle = document.querySelector('.hero-title')
                // if (heroTitle) {
                //     heroTitle.textContent = userData.username || 'Unnamed User'
                // }

                // Обновляем отображаемое имя
                const fullNameDisplay = document.getElementById('full_name_display')
                if (fullNameDisplay) {
                    fullNameDisplay.textContent = userData.full_name || 'No name provided'
                }

                // Обновляем биографию
                const bioDisplay = document.getElementById('bio_display')
                if (bioDisplay) {
                    bioDisplay.textContent = userData.bio || ''
                }

                // Обновляем аватар
                const avatarImg = document.getElementById('avatar')
                if (avatarImg) {
                    avatarImg.src = userData.avatar_url || '/images/default-avatar.png'
                    avatarImg.onerror = function () {
                        // Если изображение не загрузилось, используем дефолтное
                        this.src = '/images/default-avatar.png'
                    }
                }

                const pageTitle = document.title = `DReview — ${userData.full_name || 'User'}`

                // Обновляем счетчик отзывов
                const reviewsCount = document.getElementById('reviews_count')
                if (reviewsCount) {
                    reviewsCount.textContent = String(count ?? '0')
                }

                console.log('Profile loaded successfully')

                const { data: profile } = await supabase
                    .from('profiles')
                    .select(`favorite_game (id, title, img_url, short_description, slug), favorite_movie (id, title, img_url, short_description, slug)`)
                    .eq('id', userData.id)
                    .single()

                if (profile?.favorite_game) updateFavoriteDisplay('game', profile.favorite_game)
                if (profile?.favorite_movie) updateFavoriteDisplay('movie', profile.favorite_movie)

            } catch (error) {
                console.error('Unexpected error in main function:', error)
                const heroTitle = document.querySelector('.hero-title')
                if (heroTitle) {
                    heroTitle.textContent = 'Error loading profile'
                }
            }
        })().catch(err => {
            console.error('Critical error in main:', err)
        })

        function updateFavoriteDisplay(type, item) {
            const container = type === 'game'
                ? document.getElementById('favorite_game')
                : document.getElementById('favorite_movie')

            if (!container) return

            container.innerHTML = `
        <div class="favorite-item has-favorite">
            <a href="/pages/reviews/${type}.html?slug=${encodeURIComponent(item.slug)}">
                <img src="${item.img_url}" alt="${item.title}">
                <div class="content">
                    <h4>${item.title}</h4>
                    <p>${item.short_description}</p>
                </div>
            </a>
        </div>
        `
        }
    </script>
</body>

</html>